# ==============================================
# PLUGSPACE.IO TITAN v1.4 - DEPLOY WORKFLOW
# ==============================================
# Production deployment to Hostinger VPS
# ==============================================

name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  DEPLOY_USER: 'plugspace'
  DEPLOY_PATH: '/home/plugspace/plugspace'

jobs:
  # ===========================================
  # PRE-DEPLOYMENT CHECKS
  # ===========================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test:ci

      - name: Build check
        run: npm run build

  # ===========================================
  # DEPLOY TO PRODUCTION
  # ===========================================
  deploy:
    name: Deploy to ${{ needs.pre-deploy.outputs.environment }}
    runs-on: ubuntu-latest
    needs: pre-deploy
    environment: ${{ needs.pre-deploy.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2222 -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -p 2222 ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            set -e
            
            echo "ðŸ“¦ Starting deployment..."
            cd ${DEPLOY_PATH}
            
            # Create backup of current deployment
            echo "ðŸ“‹ Creating backup..."
            BACKUP_DIR="/home/plugspace/backups/deploy-$(date +%Y%m%d_%H%M%S)"
            mkdir -p ${BACKUP_DIR}
            cp -r package.json package-lock.json ${BACKUP_DIR}/ || true
            
            # Pull latest code
            echo "â¬‡ï¸ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            echo "ðŸ“¥ Installing dependencies..."
            npm ci --production=false
            
            # Run database migrations
            echo "ðŸ—„ï¸ Running migrations..."
            npx prisma migrate deploy || true
            
            # Build applications
            echo "ðŸ”¨ Building applications..."
            npm run build
            
            # Reload PM2 processes
            echo "ðŸ”„ Reloading processes..."
            pm2 reload ecosystem.config.js --env production
            pm2 save
            
            # Verify deployment
            echo "âœ… Verifying deployment..."
            sleep 10
            pm2 status
            
            echo "ðŸŽ‰ Deployment complete!"
          ENDSSH

      - name: Health check
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 30
          
          # Check main site
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 https://$DEPLOY_HOST/api/health || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Health check failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

      - name: Notify success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âœ… Deployment Successful",
              "attachments": [{
                "color": "good",
                "fields": [
                  { "title": "Environment", "value": "${{ needs.pre-deploy.outputs.environment }}", "short": true },
                  { "title": "Branch", "value": "${{ github.ref_name }}", "short": true },
                  { "title": "Commit", "value": "${{ github.sha }}", "short": true },
                  { "title": "Author", "value": "${{ github.actor }}", "short": true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âŒ Deployment Failed",
              "attachments": [{
                "color": "danger",
                "fields": [
                  { "title": "Environment", "value": "${{ needs.pre-deploy.outputs.environment }}", "short": true },
                  { "title": "Branch", "value": "${{ github.ref_name }}", "short": true },
                  { "title": "Commit", "value": "${{ github.sha }}", "short": true },
                  { "title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ===========================================
  # ROLLBACK JOB
  # ===========================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2222 -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -p 2222 ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            set -e
            
            echo "âª Rolling back deployment..."
            cd ${DEPLOY_PATH}
            
            # Get previous commit
            PREV_COMMIT=$(git rev-parse HEAD~1)
            
            # Rollback
            git reset --hard ${PREV_COMMIT}
            npm ci --production=false
            npm run build
            pm2 reload ecosystem.config.js --env production
            pm2 save
            
            echo "âœ… Rollback complete to ${PREV_COMMIT}"
          ENDSSH

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âª Deployment Rolled Back",
              "attachments": [{
                "color": "warning",
                "fields": [
                  { "title": "Environment", "value": "${{ needs.pre-deploy.outputs.environment }}", "short": true },
                  { "title": "Reason", "value": "Deployment health check failed", "short": true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
