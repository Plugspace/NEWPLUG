# ==============================================
# PLUGSPACE.IO TITAN v1.4 - DEPLOY WORKFLOW
# ==============================================
# Continuous Deployment Pipeline
# ==============================================

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  DEPLOY_USER: plugspace
  DEPLOY_PATH: /home/plugspace/app
  SSH_PORT: '2222'

jobs:
  # ===========================================
  # PRE-DEPLOY CHECKS
  # ===========================================
  pre-deploy:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint
        continue-on-error: true

      - name: Run type check
        run: npm run type-check
        continue-on-error: true

      - name: Run tests
        run: npm run test:ci
        continue-on-error: true

      - name: Build applications
        run: npm run build

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  # ===========================================
  # DEPLOY
  # ===========================================
  deploy:
    name: Deploy to ${{ needs.pre-deploy.outputs.environment }}
    runs-on: ubuntu-latest
    needs: pre-deploy
    environment: ${{ needs.pre-deploy.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create deployment backup
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${DEPLOY_HOST} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }} || exit 0
            
            # Create backup directory
            BACKUP_DIR="/home/plugspace/backups/deploy-$(date +%Y%m%d_%H%M%S)"
            mkdir -p ${BACKUP_DIR}
            
            # Backup current state
            if [ -f package.json ]; then
              cp package.json package-lock.json ${BACKUP_DIR}/ 2>/dev/null || true
              git rev-parse HEAD > ${BACKUP_DIR}/commit.txt 2>/dev/null || true
            fi
            
            echo "Backup created at ${BACKUP_DIR}"
          ENDSSH
        continue-on-error: true

      - name: Deploy to VPS
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${DEPLOY_HOST} << 'ENDSSH'
            set -e
            
            echo "ðŸ“¦ Starting deployment..."
            cd ${{ env.DEPLOY_PATH }}
            
            echo "â¬‡ï¸ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ“¥ Installing dependencies..."
            npm ci --production=false
            
            echo "ðŸ—„ï¸ Running database migrations..."
            npm run db:generate || true
            npm run db:push || true
            
            echo "ðŸ”¨ Building applications..."
            npm run build
            
            echo "ðŸ”„ Reloading processes..."
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
            pm2 save
            
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${DEPLOY_HOST} << 'ENDSSH'
            echo "ðŸ” Verifying deployment..."
            sleep 10
            pm2 status
            
            # Health check
            echo "ðŸ¥ Running health checks..."
            curl -sf http://localhost:4000/health || echo "API health check pending"
            curl -sf http://localhost:3000 || echo "Frontend health check pending"
            
            echo "âœ… Verification complete"
          ENDSSH
        continue-on-error: true

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Version: ${{ needs.pre-deploy.outputs.version }}"
          echo "Environment: ${{ needs.pre-deploy.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs for details"

  # ===========================================
  # ROLLBACK (on failure)
  # ===========================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Rollback deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${DEPLOY_HOST} << 'ENDSSH'
            set -e
            
            echo "âª Rolling back deployment..."
            cd ${{ env.DEPLOY_PATH }}
            
            # Get previous commit
            PREV_COMMIT=$(git rev-parse HEAD~1)
            echo "Rolling back to: ${PREV_COMMIT}"
            
            git reset --hard ${PREV_COMMIT}
            npm ci --production=false
            npm run build
            
            pm2 reload ecosystem.config.js --env production
            pm2 save
            
            echo "âœ… Rollback complete to ${PREV_COMMIT}"
          ENDSSH
        continue-on-error: true

      - name: Notify rollback
        run: |
          echo "âš ï¸ Deployment rolled back due to failure"
          echo "Manual intervention may be required"
