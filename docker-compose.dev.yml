# ==============================================
# PLUGSPACE.IO TITAN v1.4 - DEVELOPMENT OVERRIDES
# ==============================================
# Use with: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# ==============================================

version: '3.9'

services:
  # ============================================
  # SIMPLIFIED DATABASE FOR DEVELOPMENT
  # ============================================
  
  mongo-primary:
    # Simplified single-node MongoDB for development
    command: ["mongod", "--bind_ip_all"]
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: devpassword
      MONGO_INITDB_DATABASE: plugspace_dev

  # Disable replicas in development
  mongo-secondary1:
    profiles: ["production"]
  
  mongo-secondary2:
    profiles: ["production"]
  
  mongo-init-replica:
    profiles: ["production"]

  # ============================================
  # SIMPLIFIED REDIS FOR DEVELOPMENT
  # ============================================
  
  redis-master:
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    environment:
      REDIS_PASSWORD: devpassword

  # Disable Redis replica and sentinel in development
  redis-replica:
    profiles: ["production"]
  
  redis-sentinel:
    profiles: ["production"]

  # ============================================
  # APPLICATION SERVICES WITH HOT RELOAD
  # ============================================
  
  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile.dev
    environment:
      NODE_ENV: development
      PORT: 4000
      DATABASE_URL: mongodb://admin:devpassword@mongo-primary:27017/plugspace_dev?authSource=admin
      REDIS_URL: redis://redis-master:6379/0
      LOG_LEVEL: debug
    volumes:
      - ./apps/api:/app/apps/api
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/api/node_modules
    command: npm run dev

  landing:
    build:
      context: .
      dockerfile: ./apps/landing/Dockerfile.dev
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1
    volumes:
      - ./apps/landing:/app/apps/landing
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/landing/node_modules
      - /app/apps/landing/.next
    command: npm run dev

  studio:
    build:
      context: .
      dockerfile: ./apps/studio/Dockerfile.dev
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1
    volumes:
      - ./apps/studio:/app/apps/studio
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/studio/node_modules
      - /app/apps/studio/.next
    command: npm run dev

  admin:
    build:
      context: .
      dockerfile: ./apps/admin/Dockerfile.dev
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1
    volumes:
      - ./apps/admin:/app/apps/admin
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/admin/node_modules
      - /app/apps/admin/.next
    command: npm run dev

  # ============================================
  # SIMPLIFIED NGINX FOR DEVELOPMENT
  # ============================================
  
  nginx:
    volumes:
      - ./infrastructure/nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro

  # ============================================
  # DISABLE PRODUCTION-ONLY SERVICES
  # ============================================
  
  certbot:
    profiles: ["production"]
  
  alertmanager:
    profiles: ["production"]
  
  mongo-backup:
    profiles: ["production"]
  
  redis-backup:
    profiles: ["production"]
  
  healthcheck:
    profiles: ["production"]

  # ============================================
  # MONITORING WITH RELAXED SETTINGS
  # ============================================
  
  prometheus:
    ports:
      - "9090:9090"
  
  grafana:
    ports:
      - "3003:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin

  # ============================================
  # DEVELOPMENT TOOLS
  # ============================================
  
  # Mailhog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: plugspace-mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - plugspace-backend
    restart: unless-stopped

  # MongoDB Express for database UI
  mongo-express:
    image: mongo-express:latest
    container_name: plugspace-mongo-express
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: devpassword
      ME_CONFIG_MONGODB_SERVER: mongo-primary
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    networks:
      - plugspace-database
    depends_on:
      - mongo-primary
    restart: unless-stopped

  # Redis Commander for Redis UI
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: plugspace-redis-commander
    ports:
      - "8082:8081"
    environment:
      REDIS_HOSTS: local:redis-master:6379
    networks:
      - plugspace-cache
    depends_on:
      - redis-master
    restart: unless-stopped
