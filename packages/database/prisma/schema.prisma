// ==============================================
// PLUGSPACE.IO TITAN v1.4 - DATABASE SCHEMA
// ==============================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  USER
  STUDIO_ADMIN
  MASTER_ADMIN
}

enum ProjectStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum AgentName {
  DON
  MARK
  JESSICA
  SHERLOCK
  ZARA
}

enum SubscriptionTier {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

enum AccountStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
  DELETED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum TemplateStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
  ARCHIVED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum MfaMethod {
  TOTP
  SMS
  EMAIL
}

enum OAuthProvider {
  GOOGLE
  GITHUB
  MICROSOFT
  LINKEDIN
}

enum WebhookEvent {
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_PUBLISHED
  PROJECT_DELETED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  SUBSCRIPTION_CHANGED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
}

enum FeatureFlagStatus {
  ENABLED
  DISABLED
  PERCENTAGE
  USER_LIST
}

enum DeploymentEnvironment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

// ============ USER MANAGEMENT ============

model User {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  firebaseUid     String   @unique
  email           String   @unique
  displayName     String?
  photoURL        String?
  role            Role     @default(USER)

  firstName       String?
  lastName        String?
  phone           String?
  bio             String?
  timezone        String   @default("UTC")
  language        String   @default("en")
  preferences     Json?
  avatarColor     String?

  status          AccountStatus @default(PENDING)
  emailVerified   Boolean  @default(false)
  phoneVerified   Boolean  @default(false)
  verificationToken String?
  verificationExpiry DateTime?
  onboardingCompleted Boolean @default(false)

  mfaEnabled      Boolean  @default(false)
  mfaMethods      MfaMethod[] @default([])
  mfaSecret       String?
  backupCodes     String[] @default([])
  mfaRecoveryEmail String?

  lastLoginAt     DateTime?
  lastLoginIP     String?
  lastLoginUserAgent String?
  lastLoginLocation Json?
  loginAttempts   Int      @default(0)
  lockedUntil     DateTime?
  passwordChangedAt DateTime?
  securityQuestions Json?

  oauthProviders  OAuthConnection[]

  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id])
  teamRole        String?
  department      String?
  title           String?

  stripeCustomerId    String?
  subscriptionTier    SubscriptionTier @default(FREE)
  subscriptionStatus  String?
  billingCycle        BillingCycle?
  trialEndsAt         DateTime?
  creditsRemaining    Int      @default(100)
  creditsUsedThisMonth Int     @default(0)

  apiKeys           ApiKey[]
  sessions          Session[]
  projects          Project[]
  interactionLogs   InteractionLog[]
  activityLogs      ActivityLog[]
  notifications     Notification[]
  invitationsSent   Invitation[]    @relation("InvitationSender")

  createdBy       String?  @db.ObjectId
  updatedBy       String?  @db.ObjectId
  deletedBy       String?  @db.ObjectId
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  metadata        Json?

  @@index([organizationId])
  @@index([status])
  @@index([subscriptionTier])
  @@map("users")
}

model OAuthConnection {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider    OAuthProvider
  providerId  String
  email       String?
  displayName String?
  avatarUrl   String?
  accessToken String?
  refreshToken String?
  tokenExpiry DateTime?
  scope       String[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_connections")
}

model Session {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token         String   @unique
  refreshToken  String?  @unique
  
  deviceId      String?
  deviceName    String?
  deviceType    String?
  browser       String?
  os            String?
  
  ip            String?
  location      Json?
  
  isActive      Boolean  @default(true)
  lastActivityAt DateTime @default(now())
  expiresAt     DateTime
  
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ============ ORGANIZATION ============

model Organization {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  slug              String   @unique
  domain            String?  @unique
  logo              String?
  favicon           String?
  description       String?
  
  industry          String?
  size              String?
  country           String?
  website           String?
  
  tier              SubscriptionTier @default(FREE)
  billingEmail      String
  taxId             String?
  stripeCustomerId  String?
  stripeSubscriptionId String?
  billingCycle      BillingCycle @default(MONTHLY)
  subscriptionStatus String?
  trialEndsAt       DateTime?
  
  limits            Json     @default("{\"projects\": 5, \"users\": 3, \"storage\": 1073741824}")
  features          String[] @default([])
  usage             Json     @default("{\"projects\": 0, \"users\": 0, \"storage\": 0}")
  
  settings          Json?
  allowedDomains    String[] @default([])
  ssoEnabled        Boolean  @default(false)
  ssoConfig         Json?
  auditLogRetention Int      @default(90)
  
  brandingEnabled   Boolean  @default(false)
  brandingConfig    Json?
  customDomain      String?
  
  users             User[]
  projects          Project[]
  themes            Theme[]
  apiKeys           ApiKey[]
  webhooks          Webhook[]
  invitations       Invitation[]
  departments       Department[]
  
  createdBy         String?  @db.ObjectId
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?
  metadata          Json?

  @@index([tier])
  @@map("organizations")
}

model Department {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  parentId        String?  @db.ObjectId
  costCenter      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, name])
  @@map("departments")
}

model Invitation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  email           String
  role            Role     @default(USER)
  teamRole        String?
  department      String?
  
  token           String   @unique
  status          InvitationStatus @default(PENDING)
  
  invitedBy       String   @db.ObjectId
  inviter         User     @relation("InvitationSender", fields: [invitedBy], references: [id])
  
  message         String?
  expiresAt       DateTime
  acceptedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, email])
  @@map("invitations")
}

// ============ PROJECT ============

model Project {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  subdomain         String   @unique
  customDomain      String?  @unique

  userId            String   @db.ObjectId
  user              User     @relation(fields: [userId], references: [id])
  organizationId    String   @db.ObjectId
  organization      Organization @relation(fields: [organizationId], references: [id])

  status            ProjectStatus @default(DRAFT)
  isPublished       Boolean  @default(false)
  publishedAt       DateTime?
  reviewNotes       String?
  reviewedBy        String?  @db.ObjectId

  architecture      Json?
  architectureVersion Int    @default(1)
  design            Json?
  designVersion     Int      @default(1)
  codeFiles         Json?
  dependencies      Json?
  codeVersion       Int      @default(1)

  clonedFrom        String?
  cloneAnalysis     Json?
  cloneUrl          String?

  deploymentUrl     String?
  deploymentEnv     DeploymentEnvironment @default(PRODUCTION)
  sslEnabled        Boolean  @default(false)
  cdnEnabled        Boolean  @default(false)
  cdnUrl            String?
  
  seoConfig         Json?
  analyticsId       String?
  performanceScore  Int?

  version           Int      @default(1)
  previousVersions  Json[]   @default([])
  gitRepoUrl        String?
  lastDeployedAt    DateTime?
  deploymentHistory Json[]   @default([])

  collaborators     Json[]   @default([])
  comments          Json[]   @default([])
  
  views             Int      @default(0)
  uniqueVisitors    Int      @default(0)
  lastViewedAt      DateTime?
  analyticsData     Json?
  settings          Json?
  
  interactionLogs   InteractionLog[]
  deployments       Deployment[]
  backups           ProjectBackup[]

  createdBy         String?  @db.ObjectId
  updatedBy         String?  @db.ObjectId
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?
  metadata          Json?

  @@index([organizationId, userId])
  @@index([status])
  @@index([isPublished])
  @@map("projects")
}

model Deployment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId     String   @db.ObjectId
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  version       Int
  environment   DeploymentEnvironment
  status        String
  url           String?
  
  buildLogs     String?
  buildDuration Int?
  bundleSize    Int?
  
  previousDeploymentId String? @db.ObjectId
  isRolledBack  Boolean  @default(false)
  
  deployedBy    String   @db.ObjectId
  deployedAt    DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@index([deployedAt])
  @@map("deployments")
}

model ProjectBackup {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId     String   @db.ObjectId
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  version       Int
  name          String?
  description   String?
  data          Json
  size          Int
  type          String   @default("manual")
  
  createdBy     String   @db.ObjectId
  createdAt     DateTime @default(now())
  expiresAt     DateTime?

  @@index([projectId])
  @@map("project_backups")
}

// ============ AI INTERACTION ============

model InteractionLog {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  projectId       String   @db.ObjectId
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id])
  organizationId  String   @db.ObjectId

  agentName       AgentName
  agentModel      String
  agentVersion    String?
  
  requestId       String   @unique @default(uuid())
  input           String
  inputTokens     Int      @default(0)
  systemPrompt    String?
  output          Json
  outputTokens    Int      @default(0)
  
  parentInteractionId String? @db.ObjectId
  chainPosition   Int?

  tokensUsed      Int
  latencyMs       Int
  cost            Float    @default(0.0)
  
  success         Boolean  @default(true)
  errorCode       String?
  errorMessage    String?
  retryCount      Int      @default(0)
  
  rating          Int?
  feedback        String?
  flagged         Boolean  @default(false)
  flagReason      String?
  
  experimentId    String?
  variant         String?

  timestamp       DateTime @default(now())
  ip              String?
  userAgent       String?
  metadata        Json?

  @@index([projectId, timestamp])
  @@index([userId, timestamp])
  @@index([organizationId, timestamp])
  @@index([agentName, timestamp])
  @@index([success])
  @@map("interaction_logs")
}

// ============ TEMPLATE ============

model Template {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  slug            String   @unique
  category        String
  subcategory     String?
  type            String

  description     String?
  shortDescription String?
  templateData    Json
  
  version         String   @default("1.0.0")
  changelog       Json[]   @default([])
  
  authorId        String?  @db.ObjectId
  authorName      String?
  authorAvatar    String?
  isOfficial      Boolean  @default(false)

  status          TemplateStatus @default(DRAFT)
  reviewNotes     String?
  reviewedBy      String?  @db.ObjectId
  reviewedAt      DateTime?
  
  featured        Boolean  @default(false)
  featuredOrder   Int?
  price           Float    @default(0.0)
  currency        String   @default("USD")
  isPremium       Boolean  @default(false)
  
  downloads       Int      @default(0)
  views           Int      @default(0)
  rating          Float    @default(0.0)
  ratingCount     Int      @default(0)
  
  previewImage    String?
  thumbnailImage  String?
  screenshots     String[] @default([])
  demoUrl         String?
  videoUrl        String?

  tags            String[] @default([])
  keywords        String[] @default([])
  license         String   @default("MIT")
  
  reviews         TemplateReview[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?
  deletedAt       DateTime?
  metadata        Json?

  @@index([category])
  @@index([featured])
  @@index([status])
  @@index([rating])
  @@map("templates")
}

model TemplateReview {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  templateId  String   @db.ObjectId
  template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  userId      String   @db.ObjectId
  userName    String?
  userAvatar  String?
  
  rating      Int
  title       String?
  content     String
  
  helpful     Int      @default(0)
  notHelpful  Int      @default(0)
  isVerified  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([templateId, userId])
  @@index([templateId])
  @@map("template_reviews")
}

// ============ THEME ============

model Theme {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id])

  method          String
  sourceUrl       String?
  sourceImage     String?
  sourceHtml      String?

  colors          Json
  typography      Json
  components      Json
  spacing         Json?
  borderRadius    Json?
  shadows         Json?
  
  cssVariables    String?
  tailwindConfig  Json?
  
  industry        String?
  style           String?
  mood            String?
  isActive        Boolean  @default(false)
  isDefault       Boolean  @default(false)
  isPublic        Boolean  @default(false)
  shareToken      String?

  createdBy       String?  @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@map("themes")
}

// ============ SYSTEM ============

model SystemConfig {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     Json
  category  String?
  description String?
  updatedBy String?  @db.ObjectId
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_config")
}

model FeatureFlag {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  name        String
  description String?
  status      FeatureFlagStatus @default(DISABLED)
  percentage  Int?
  userList    String[] @default([])
  tiers       SubscriptionTier[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("feature_flags")
}

model MaintenanceWindow {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  isActive    Boolean  @default(false)
  message     String?
  createdBy   String   @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("maintenance_windows")
}

// ============ AUDIT ============

model ActivityLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  userEmail   String
  organizationId String? @db.ObjectId
  
  action      String
  category    String?
  resource    String?
  resourceId  String?
  
  details     Json?
  changes     Json?
  
  ip          String?
  userAgent   String?
  location    Json?
  sessionId   String?
  requestId   String?
  
  sensitiveDataAccessed Boolean @default(false)
  exportable  Boolean  @default(true)
  
  timestamp   DateTime @default(now())

  @@index([userId, timestamp])
  @@index([organizationId, timestamp])
  @@index([action, timestamp])
  @@map("activity_logs")
}

// ============ API ============

model ApiKey {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  
  keyPrefix       String
  keyHash         String
  
  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id])
  
  scopes          String[] @default(["read"])
  allowedIps      String[] @default([])
  allowedOrigins  String[] @default([])
  
  rateLimit       Int      @default(1000)
  rateLimitWindow Int      @default(60000)
  
  lastUsedAt      DateTime?
  lastUsedIp      String?
  usageCount      Int      @default(0)
  usageThisMonth  Int      @default(0)
  
  isActive        Boolean  @default(true)
  expiresAt       DateTime?
  revokedAt       DateTime?
  revokedBy       String?  @db.ObjectId
  revokeReason    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([keyPrefix])
  @@map("api_keys")
}

model Webhook {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  url             String
  
  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  events          WebhookEvent[]
  secret          String
  headers         Json?
  
  isActive        Boolean  @default(true)
  isPaused        Boolean  @default(false)
  
  lastTriggeredAt DateTime?
  lastResponseCode Int?
  lastResponseBody String?
  
  failureCount    Int      @default(0)
  consecutiveFailures Int  @default(0)
  disabledAt      DateTime?
  
  maxRetries      Int      @default(3)
  retryDelayMs    Int      @default(1000)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@map("webhooks")
}

model WebhookDelivery {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  webhookId   String   @db.ObjectId
  
  event       WebhookEvent
  payload     Json
  
  statusCode  Int?
  responseBody String?
  responseTime Int?
  
  success     Boolean  @default(false)
  error       String?
  attempts    Int      @default(1)
  
  deliveredAt DateTime @default(now())

  @@index([webhookId])
  @@map("webhook_deliveries")
}

// ============ NOTIFICATIONS ============

model Notification {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String
  category    String?
  title       String
  message     String
  
  actionUrl   String?
  actionLabel String?
  
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  emailSent   Boolean  @default(false)
  pushSent    Boolean  @default(false)
  
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ============ RATE LIMITING ============

model RateLimitRecord {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String
  endpoint    String
  count       Int      @default(1)
  windowStart DateTime @default(now())
  expiresAt   DateTime

  @@unique([key, endpoint])
  @@index([expiresAt])
  @@map("rate_limit_records")
}

// ============ EMAIL ============

model EmailTemplate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  name        String
  description String?
  subject     String
  htmlBody    String
  textBody    String?
  variables   String[] @default([])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}
